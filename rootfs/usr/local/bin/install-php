#!/bin/sh
#
# install-php - Installs PHP and optionally Composer
#
# Usage: install-php <php_version> [--composer]
#
# Arguments:
#   php_version    PHP version to install (e.g., 8.3)
#   --composer     If provided, also installs Composer
#   --zts          If provided, installs ZTS version of PHP
#   --frankenphp   If provided, installs frankenphp php and extensions instead of normal php
#
# Examples:
#   install-php 8.3
#   install-php 8.4 --composer --zts --frankenphp

EXTENSIONS="ctype curl date dom fileinfo filter hash iconv json libxml mbstring opcache openssl pcre phar readline session tokenizer xml zlib pdo"

set -e

error_exit() {
    echo-color red "ERROR: $1" >&2
    exit 1
}

[ -t 1 ] && QUIET="--quiet" || QUIET=""

if [ $# -eq 0 ]; then
    error_exit "PHP version is required Usage: php-install <php_version> [--composer] [--frankenphp]"
fi

# First argument must be the PHP version
PHP_VERSION=$1
shift
if ! echo "$PHP_VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
    error_exit "Invalid PHP version format: $PHP_VERSION. Expected format: X.Y (e.g., 8.3)"
fi

PHP_APK_PACKAGE="php-$PHP_VERSION"
INSTALL_ZTS=false
INSTALL_COMPOSER=false
INSTALL_FRANKENPHP=false

for arg in "$@"; do
    case "$arg" in
        "--composer")
            INSTALL_COMPOSER=true
            ;;
        "--zts")
            INSTALL_ZTS=true
            PHP_APK_PACKAGE="php-$PHP_VERSION-zts"
            ;;
        "--frankenphp")
            INSTALL_ZTS=true
            INSTALL_FRANKENPHP=true
            PHP_APK_PACKAGE="php-$PHP_VERSION-zts"
            ;;
        *)
            error_exit "Unknown option: $arg"
            ;;
    esac
done

# If PHP is already present and is ZTS, prefer the ZTS package name; otherwise keep the current choice
if command -v php > /dev/null 2>&1; then
    if php -r 'exit(PHP_ZTS ? 0 : 1);'; then
        INSTALL_ZTS=true
        PHP_APK_PACKAGE="php-$PHP_VERSION-zts"
    fi
fi

EXTRA=""
[ "$INSTALL_ZTS" = true ] && EXTRA="${EXTRA} ZTS"
[ "$INSTALL_FRANKENPHP" = true ] && EXTRA="${EXTRA} with FrankenPHP"
EXTRA=$(echo "$EXTRA" | sed 's/^ *//')
echo-color cyan "üêò Installing PHP $PHP_VERSION${EXTRA:+ $EXTRA}..."

# Install PHP
if ! apk add --no-cache \
    ca-certificates \
    ${PHP_APK_PACKAGE} \
    $([ "$INSTALL_FRANKENPHP" = true ] && echo "frankenphp ${PHP_APK_PACKAGE}-pcntl" || echo "") \
    $QUIET; then
    error_exit "Failed to install PHP $PHP_VERSION"
fi

INSTALLED_MODULES=$(list-installed-modules)
TMP_INSTALLED=$(mktemp)
TMP_REQUESTED=$(mktemp)
trap 'rm -f "$TMP_INSTALLED" "$TMP_REQUESTED"' EXIT
printf '%s\n' $INSTALLED_MODULES > "$TMP_INSTALLED"
printf '%s\n' $EXTENSIONS > "$TMP_REQUESTED"

FILTERED_EXTENSIONS=$(grep -vxFf "$TMP_INSTALLED" "$TMP_REQUESTED" || true)

# Install base extensions required for Laravel
if [ -n "$FILTERED_EXTENSIONS" ]; then
    APK_PACKAGES=$(printf '%s\n' $FILTERED_EXTENSIONS | sed "s#^#${PHP_APK_PACKAGE}-#")

    echo-color cyan "‚öôÔ∏è  Installing base extensions for Laravel..."
    if ! apk add --no-cache $APK_PACKAGES $QUIET; then
        error_exit "Failed to install PHP base extensions: $FILTERED_EXTENSIONS"
    fi
fi

# Install Composer if flag is set
if [ "$INSTALL_COMPOSER" = true ]; then
    echo-color cyan "üì¶ Installing Composer..."

    if ! install-composer; then
        error_exit "Failed to install Composer"
    fi

    echo-color green "‚úÖ PHP $PHP_VERSION${EXTRA:+ $EXTRA}, base Laravel required extensions and Composer installation completed successfully."
else
    echo-color green "‚úÖ PHP $PHP_VERSION${EXTRA:+ $EXTRA} and base Laravel required extensions installation completed successfully."
fi
