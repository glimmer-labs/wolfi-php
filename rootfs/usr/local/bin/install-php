#!/bin/sh
#
# install-php - Installs PHP and optionally Composer
#
# Usage: install-php <php_version> [--composer]
#
# Arguments:
#   php_version    PHP version to install (e.g., 8.3)
#   --composer     If provided, also installs Composer
#   --frankenphp   If provided, installs frankenphp php and extensions instead of normal php
#
# Examples:
#   install-php 8.3
#   install-php 8.4 --composer --frankenphp

EXTENSIONS="curl date dom fileinfo filter hash iconv json libxml mbstring opcache openssl pcre phar readline session tokenizer xml zlib pdo"

set -e

error_exit() {
    echo-color red "ERROR: $1" >&2
    exit 1
}

if [ $# -eq 0 ]; then
    error_exit "PHP version is required Usage: php-install <php_version> [--composer] [--frankenphp]"
fi

# First argument must be the PHP version
PHP_VERSION=$1
shift
if ! echo "$PHP_VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
    error_exit "Invalid PHP version format: $PHP_VERSION. Expected format: X.Y (e.g., 8.3)"
fi

PHP_APK_PREFIX="php"
INSTALL_COMPOSER=false

for arg in "$@"; do
    case "$arg" in
        "--composer")
            INSTALL_COMPOSER=true
            ;;
        "--frankenphp")
            add-shyim-repo
            PHP_APK_PREFIX="php-frankenphp"
            ;;
        *)
            error_exit "Unknown option: $arg"
            ;;
    esac
done

# Fallback in case the script is called twice and the first time was with --frankenphp
PHP_APK_PREFIX=$(apk info -e "frankenphp-${PHP_VERSION}" > /dev/null 2>&1 && echo "php-frankenphp" || echo $PHP_APK_PREFIX)

ENGINE=$([ "$PHP_APK_PREFIX" = "php-frankenphp" ] && echo "FrankenPHP" || echo "PHP")
echo-color cyan "üêò Installing $ENGINE $PHP_VERSION..."

# Install PHP
if ! apk add --no-cache \
    ca-certificates \
    $([ "$PHP_APK_PREFIX" = "php-frankenphp" ] && echo "frankenphp-${PHP_VERSION} ${PHP_APK_PREFIX}-${PHP_VERSION}-pcntl" || echo "") \
    ${PHP_APK_PREFIX}-${PHP_VERSION} \
    curl --quiet; then
    error_exit "Failed to install PHP $PHP_VERSION"
fi

INSTALLED_MODULES=$(list-installed-modules)
TMP_INSTALLED=$(mktemp)
TMP_REQUESTED=$(mktemp)
trap 'rm -f "$TMP_INSTALLED" "$TMP_REQUESTED"' EXIT
printf '%s\n' $INSTALLED_MODULES > "$TMP_INSTALLED"
printf '%s\n' $EXTENSIONS > "$TMP_REQUESTED"

FILTERED_EXTENSIONS=$(grep -vxFf "$TMP_INSTALLED" "$TMP_REQUESTED" || true)

# Install base extensions required for Laravel
if [ -n "$FILTERED_EXTENSIONS" ]; then
    APK_PACKAGES=$(printf '%s\n' $FILTERED_EXTENSIONS | sed "s#^#${PHP_APK_PREFIX}-${PHP_VERSION}-#")

    echo-color cyan "‚öôÔ∏è  Installing base extensions for Laravel..."
    if ! apk add --no-cache $APK_PACKAGES --quiet; then
        error_exit "Failed to install PHP base extensions: $FILTERED_EXTENSIONS"
    fi
fi

# Install Composer if flag is set
if [ "$INSTALL_COMPOSER" = true ]; then
    echo-color cyan "üì¶ Installing Composer..."

    if ! install-composer; then
        error_exit "Failed to install Composer"
    fi

    echo-color green "‚úÖ $ENGINE $PHP_VERSION, base Laravel required extensions and Composer installation completed successfully."
else
    echo-color green "‚úÖ $ENGINE $PHP_VERSION and base Laravel required extensions installation completed successfully."
fi
