#!/bin/sh
#
# add-php-extensions - Installs PHP extensions
#
# Usage: add-php-extensions [extension1 extension2 ...]
#
# Examples:
#   add-php-extensions pgsql redis

set -e

# ----------------
# Helper functions
# ----------------
error_exit() {
    echo-color red "ERROR: $1" >&2
    exit 1
}

map_extension() {
    _ext="$1"

    case "$_ext" in
        sqlite)
            echo "$(ext_to_apk pdo_sqlite)"
            return
            ;;
        mysql|mysqli)
            echo "$(ext_to_apk mysqli) $(ext_to_apk mysqlnd) $(ext_to_apk pdo_mysql)"
            return
            ;;
        pgsql|dblib|oci|odbc)
            echo "$(ext_to_apk $_ext) $(ext_to_apk pdo_$_ext)"
            return
            ;;
        swoole)
            echo "$(ext_to_apk swoole) $(ext_to_apk posix) $(ext_to_apk pcntl)"
            return
            ;;
        *)
            echo "$(ext_to_apk $_ext)"
            return
            ;;
    esac
}

ext_to_apk() {
    _ext="$1"
    echo "${PHP_APK_PREFIX}-${PHP_VERSION}-${_ext}"
    return
}

# -----------
# Main script
# -----------
if ! command -v php > /dev/null 2>&1; then
    error_exit "PHP is not installed"
fi

PHP_VERSION=$(php -r 'echo PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION;')
PHP_APK_PREFIX=$(apk info -e "frankenphp-${PHP_VERSION}" > /dev/null 2>&1 && echo "php-frankenphp" || echo "php")

if ! echo "$PHP_VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
    error_exit "Invalid PHP version format: $PHP_VERSION"
fi

# Collect all packages to install
INSTALLED_MODULES=$(list-installed-modules)
TMP_INSTALLED=$(mktemp)
TMP_REQUESTED=$(mktemp)
trap 'rm -f "$TMP_INSTALLED" "$TMP_REQUESTED"' EXIT
printf '%s\n' $INSTALLED_MODULES > "$TMP_INSTALLED"
printf '%s\n' $@ > "$TMP_REQUESTED"

FILTERED_EXTENSIONS=$(grep -vxFf "$TMP_INSTALLED" "$TMP_REQUESTED" || true | xargs)
MATCHING_EXTENSIONS=$(grep -xFf "$TMP_INSTALLED" "$TMP_REQUESTED" || true | xargs)

ALL_PACKAGES=""

[ -n "$MATCHING_EXTENSIONS" ] && 
echo-color yellow "âš ï¸  These extensions are already installed and will be skipped:" &&
echo-color yellow "   > $(echo "$MATCHING_EXTENSIONS" | tr '\n' ' ' | sed 's/  */, /g; s/, $//')\n"

for ext in $FILTERED_EXTENSIONS; do
    [ -n "$ext" ] || continue
    PACKAGES=$(map_extension "$ext")
    ALL_PACKAGES="$ALL_PACKAGES $PACKAGES"
done

ALL_PACKAGES=$(echo "$ALL_PACKAGES" | xargs) # Trim and normalize spaces

if [ -z "$ALL_PACKAGES" ]; then
    echo "No extensions to install."
    exit 0
fi

echo-color cyan "ðŸ“¦ Installing extensions:"
echo "   > $(echo "$ALL_PACKAGES" | tr '\n' ' ' | sed 's/  */, /g; s/, $//')"

if ! apk add --no-cache $ALL_PACKAGES --quiet; then
    error_exit "Failed to install extensions"
fi

echo-color green "âœ… Extensions installation complete."
