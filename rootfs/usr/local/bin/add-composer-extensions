#!/bin/sh
#
# add-composer-extensions - Extracts required PHP extensions from composer.json and installs them
#
# Usage: add-composer-extensions [--no-dev] [--check-only]
#
# Options:
#   --no-dev         Skip dev dependencies
#   --check-only     Only check for missing extensions, don't install them
#
# Examples:
#   add-composer-extensions
#   add-composer-extensions --no-dev
#

set -e

error_exit() {
    echo-color red "ERROR: $1" >&2
    exit 1
}

if ! command -v php > /dev/null 2>&1; then
    error_exit "PHP is not installed"
fi

PHP_VERSION=$(php -r 'echo PHP_MAJOR_VERSION . "." . PHP_MINOR_VERSION;')

if ! echo "$PHP_VERSION" | grep -qE '^[0-9]+\.[0-9]+$'; then
    error_exit "Invalid PHP version format: $PHP_VERSION"
fi

NO_DEV_FLAG=""
CHECK_ONLY_FLAG=false
COMPOSER_INSTALLED=true

for arg in "$@"; do
    case "$arg" in
        "--no-dev")
            NO_DEV_FLAG="--no-dev"
            ;;
        "--check-only")
            CHECK_ONLY_FLAG=true
            ;;
        *)
            error_exit "Unknown option: $arg"
            ;;
    esac
done

if ! command -v composer >/dev/null 2>&1; then
    COMPOSER_INSTALLED=false
fi

if [ "$COMPOSER_INSTALLED" = false ]; then
    install-composer > /dev/null 2>&1
fi

echo-color cyan "ðŸ“‹ Checking for additional missing PHP extensions..."

# Check for composer.json and composer.lock
if [ ! -f "composer.json" ]; then
    error_exit "composer.json file not found. Please ensure it exists."
fi

if [ ! -f "composer.lock" ]; then
    error_exit "composer.lock file not found. Please ensure it exists."
fi

# Check for missing PHP extensions using composer
MISSING_REQS=$(composer check-platform-reqs $NO_DEV_FLAG --lock 2>/dev/null | grep -i "missing" || true)

if [ -z "$MISSING_REQS" ]; then
    echo-color green "âœ… No missing PHP extensions found."
    exit 0
else
    echo-color yellow "âš ï¸  Found missing PHP extensions."

    # Extract extension names from composer output
    MISSING_EXTENSIONS=$(echo "$MISSING_REQS" | awk '{print $1}' | sed 's/ext-//' | tr '\n' ' ' | xargs)

    if [ "$CHECK_ONLY_FLAG" = true ]; then
        for ext in $MISSING_EXTENSIONS; do
            echo "  - $ext" >&2
        done
        echo-color yellow "Please install them to continue." >&2
        exit 1
    else
        add-php-extensions $MISSING_EXTENSIONS || exit $?
    fi
fi

if [ "$COMPOSER_INSTALLED" = false ]; then
    remove-composer > /dev/null 2>&1
fi
